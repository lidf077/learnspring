<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3235"/>
<h1>6、Spring源码</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/6/17 8:52</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/6/17 15:46</i></td></tr>
<tr><td><b>作者：</b></td><td><i>雷丰阳</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div>1、Spring-IOC-AOP（动态代理）；多层代理</div><div>               LogAspectpRroxy{</div><div>                         try{</div><div>                              @Before</div><div>                              method.invoke()//pjp.procced(args){</div><div>                                        BAspectProxy{</div><div>                                                       @Before</div><div>                                                       method.invoke()//---目标方法</div><div>                                                         @AfterReturning</div><div>                                                        //xxxxxxxx</div><div>                                                            //修改了返回值</div><div>                                        }</div><div>                              }</div><div>                              @AfterReturning</div><div>                         }catch(e){</div><div>                               @AfterThrowing</div><div>                         }finally{</div><div>                               @After </div><div>                         }        </div><div>               }</div><div><hr/></div><div>IOC：</div><div>     1、IOC是一个容器</div><div>     2、容器启动的时候创建所有单实例对象</div><div>     3、我们可以直接从容器中获取到这个对象</div><div>SpringIOC：</div><div>     1）、ioc容器的启动过程？启动期间都做了什么（什么时候创建所有单实例bean）</div><div>     2）、ioc是如何创建这些单实例bean，并如何管理的；到底保存在了那里？</div><div><hr/></div><div>思路：</div><div>          从HelloWorld开始，调试每个方法的作用；</div><div>1、ClassPathXMLApplicationContext构造器</div><div><br/></div><div>ApplicationContext ioc =new ClassPathXmlApplicationContext(&quot;ioc.xml&quot;)</div><div align="left" style="min-height: 18pt;"><div><font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae"><b>this</b></span></font><font face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae">(</span></font><font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae"><b>new</b></span></font> <font face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae">String[] {configLocation},</span></font> <font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae"><b>true</b></span></font><font face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae">,</span></font> <font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae"><b>null</b></span></font><font face="Consolas" size="4"><span style="font-size:16pt; background:#c6dbae">);</span></font></div></div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)</div><div>            throws BeansException {</div><div><br/></div><div>        super(parent);</div><div>        setConfigLocations(configLocations);</div><div>        if (refresh) {</div><div>               //所有单实例bean创建完成</div><div>           <span style="color: rgb(227, 0, 0);"><b> refresh();</b></span></div><div>        }</div><div>    }</div></div><div><br/></div><div><br/></div><div><img src="6、Spring源码_files/Image.png" type="image/png" style="height: auto;"/></div><div><b>BeanFactory：Bean工厂；</b></div><div><b><br/></b></div></div><div align="left" style="min-height: 18pt;"><div><span style="color: rgb(227, 0, 0);"><b>refresh();实现；Spring；BeanFactory的流程；也是ioc容器的创建流程</b></span></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@Override</div><div>    public void refresh() throws BeansException, IllegalStateException {</div><div>        synchronized (this.startupShutdownMonitor) {</div><div>            // Prepare this context for refreshing.</div><div>            prepareRefresh();</div><div><br/></div><div>            // Tell the subclass to refresh the internal bean factory.</div><div>              <span style="color: rgb(255, 0, 0);"> //Spring解析xml配置文件将要创建的所有bean的配置信息保存起来，观看Spring对xml的解析</span></div><div>            <span style="color: rgb(227, 0, 0);">ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span></div><div><br/></div><div>            // Prepare the bean factory for use in this context.</div><div>            prepareBeanFactory(beanFactory);</div><div><br/></div><div>            try {</div><div>                // Allows post-processing of the bean factory in context subclasses.</div><div>                postProcessBeanFactory(beanFactory);</div><div><br/></div><div>                // Invoke factory processors registered as beans in the context.</div><div>                invokeBeanFactoryPostProcessors(beanFactory);</div><div><br/></div><div>                // Register bean processors that intercept bean creation.</div><div>                registerBeanPostProcessors(beanFactory);</div><div><br/></div><div>                // Initialize message source for this context.</div><div>                <span style="color: rgb(227, 0, 0);">//支持国际化功能的；</span></div><div>               <span style="color: rgb(227, 0, 0);"> initMessageSource();</span></div><div><br/></div><div>                // Initialize event multicaster for this context.</div><div>                initApplicationEventMulticaster();</div><div><br/></div><div>                // Initialize other special beans in specific context subclasses.</div><div>              <span style="color: rgb(227, 0, 0);"> //留给子类的方法</span></div><div>               <span style="color: rgb(227, 0, 0);"> onRefresh();</span></div><div><br/></div><div>                // Check for listener beans and register them.</div><div>                registerListeners();</div><div><br/></div><div>                // Instantiate all remaining (non-lazy-init) singletons.</div><div>               <span style="color: rgb(227, 0, 0);">//初始化所有单实例bean的地方</span></div><div>                <b><span style="color: rgb(227, 0, 0);">finishBeanFactoryInitialization(beanFactory);</span></b></div><div><br/></div><div>                // Last step: publish corresponding event.</div><div>                finishRefresh();</div><div>            }</div><div><br/></div><div>            catch (BeansException ex) {</div><div>                // Destroy already created singletons to avoid dangling resources.</div><div>                destroyBeans();</div><div><br/></div><div>                // Reset 'active' flag.</div><div>                cancelRefresh(ex);</div><div><br/></div><div>                // Propagate exception to caller.</div><div>                throw ex;</div><div>            }</div><div>        }</div><div>    }</div></div><div><br/></div></div><div><b><span style="color: rgb(227, 0, 0);">finishBeanFactoryInitialization(beanFactory);实现</span></b></div><div><font color="#E30000"><b>AbstractApplicationContext：</b></font></div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {</div><div>        // Initialize conversion service for this context.</div><div>        if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</div><div>                beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) {</div><div>            beanFactory.setConversionService(</div><div>                    beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</div><div>        }</div><div><br/></div><div>        // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</div><div>        String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);</div><div>        for (String weaverAwareName : weaverAwareNames) {</div><div>            getBean(weaverAwareName);</div><div>        }</div><div><br/></div><div>        // Stop using the temporary ClassLoader for type matching.</div><div>        beanFactory.setTempClassLoader(null);</div><div><br/></div><div>        // Allow for caching all bean definition metadata, not expecting further changes.</div><div>        beanFactory.freezeConfiguration();</div><div><br/></div><div>        // Instantiate all remaining (non-lazy-init) singletons.初始化所有单实例</div><div>       <b><span style="color: rgb(227, 0, 0);"> beanFactory.preInstantiateSingletons();</span></b></div><div>    }</div></div><div><br/></div></div><div align="left" style="min-height: 18pt;"><div><br/></div><div>DefaultListableBeanFactory：bean工厂；创建bean</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@Override</div><div>    public void preInstantiateSingletons() throws BeansException {</div><div>        if (this.logger.isDebugEnabled()) {</div><div>            this.logger.debug(&quot;Pre-instantiating singletons in &quot; + this);</div><div>        }</div><div><br/></div><div>          <span style="color: rgb(227, 0, 0);">//拿到所有要创建的bean的名字</span></div><div>        List&lt;String&gt; beanNames;</div><div>        synchronized (this.beanDefinitionMap) {</div><div>            // Iterate over a copy to allow for init methods which in turn register new bean definitions.</div><div>            // While this may not be part of the regular factory bootstrap, it does otherwise work fine.</div><div>            beanNames = new ArrayList&lt;String&gt;(this.beanDefinitionNames);</div><div>        }</div><div><br/></div><div><br/></div><div>          <span style="color: rgb(227, 0, 0);">//按顺序创建bean</span></div><div>        for (String beanName : beanNames) {</div><div>            //根据beandid获取到bean的定义信息；</div><div>           <b><span style="color: rgb(227, 0, 0);"> RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span></b></div><div><b><span style="color: rgb(227, 0, 0);"><br/></span></b></div><div><b><span style="color: rgb(227, 0, 0);">               //判断bean是单实例的，并且不是抽象的，并且不是懒加载的</span></b></div><div>            <b>if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) {</b></div><div><b>                   //是否是一个实现了FactoryBean接口的bean<br/></b></div><div>                <b>if (isFactoryBean(beanName)) {</b></div><div>                    final FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName);</div><div>                    boolean isEagerInit;</div><div>                    if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) {</div><div>                        isEagerInit = AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() {</div><div>                            @Override</div><div>                            public Boolean run() {</div><div>                                return ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit();</div><div>                            }</div><div>                        }, getAccessControlContext());</div><div>                    }</div><div>                    else {</div><div>                        isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp;</div><div>                                ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</div><div>                    }</div><div>                    if (isEagerInit) {</div><div>                        getBean(beanName);</div><div>                    }</div><div>                <b>}</b></div><div>                else {</div><div>                    getBean(beanName);</div><div>                }</div><div>            }</div><div>        }</div><div>    }</div></div><div align="left" style="min-height: 18pt;"><div><font face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">getBean(beanName);创建bean的细节</span></font></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>getBean(){</div><div>           //所有的getBean掉的是它</div><div>          <span style="color: rgb(227, 0, 0);">doGetBean(name, null, null, false);</span></div><div>}</div></div><div><b><span style="color: rgb(227, 0, 0);">AbstractBeanFactory：doGetBean(name, null, null, false);</span></b></div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>@SuppressWarnings(&quot;unchecked&quot;)</div><div>    protected &lt;T&gt; T doGetBean(</div><div>            final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly)</div><div>            throws BeansException {</div><div><br/></div><div>        final String beanName = transformedBeanName(name);</div><div>        Object bean;</div><div><br/></div><div>        // Eagerly check singleton cache for manually registered singletons.</div><div>          <span style="color: rgb(227, 0, 0);">//先从已经注册的所有单实例bean中看有没有个bean。第一次创建bean是没有的；</span></div><div>      <span style="color: rgb(227, 0, 0);"><b>  Object sharedInstance = getSingleton(beanName);</b></span></div><div>        if (sharedInstance != null &amp;&amp; args == null) {</div><div>            if (logger.isDebugEnabled()) {</div><div>                if (isSingletonCurrentlyInCreation(beanName)) {</div><div>                    logger.debug(&quot;Returning eagerly cached instance of singleton bean '&quot; + beanName +</div><div>                            &quot;' that is not fully initialized yet - a consequence of a circular reference&quot;);</div><div>                }</div><div>                else {</div><div>                    logger.debug(&quot;Returning cached instance of singleton bean '&quot; + beanName + &quot;'&quot;);</div><div>                }</div><div>            }</div><div>            bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);</div><div>        }</div><div><br/></div><div>        else {</div><div>            // Fail if we're already creating this bean instance:</div><div>            // We're assumably within a circular reference.</div><div>            if (isPrototypeCurrentlyInCreation(beanName)) {</div><div>                throw new BeanCurrentlyInCreationException(beanName);</div><div>            }</div><div><br/></div><div>            // Check if bean definition exists in this factory.</div><div>            BeanFactory parentBeanFactory = getParentBeanFactory();</div><div>            if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) {</div><div>                // Not found -&gt; check parent.</div><div>                String nameToLookup = originalBeanName(name);</div><div>                if (args != null) {</div><div>                    // Delegation to parent with explicit args.</div><div>                    return (T) parentBeanFactory.getBean(nameToLookup, args);</div><div>                }</div><div>                else {</div><div>                    // No args -&gt; delegate to standard getBean method.</div><div>                    return parentBeanFactory.getBean(nameToLookup, requiredType);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!typeCheckOnly) {</div><div>                markBeanAsCreated(beanName);</div><div>            }</div><div><br/></div><div>            try {</div><div>                final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</div><div>                checkMergedBeanDefinition(mbd, beanName, args);</div><div><br/></div><div>                // Guarantee initialization of beans that the current bean depends on.</div><div>               //拿到创建当前bean之前需要提前创建的bean。depends-on属性；如果有就循环创建</div><div>               <span style="color: rgb(227, 0, 0);"> String[] dependsOn = mbd.getDependsOn();</span></div><div><span style="color: rgb(227, 0, 0);"><br/></span></div><div>               <span style="color: rgb(227, 0, 0);"> if (dependsOn != null) {</span></div><div>                    for (String dependsOnBean : dependsOn) {</div><div>                        if (isDependent(beanName, dependsOnBean)) {</div><div>                            throw new BeanCreationException(&quot;Circular depends-on relationship between '&quot; +</div><div>                                    beanName + &quot;' and '&quot; + dependsOnBean + &quot;'&quot;);</div><div>                        }</div><div>                        registerDependentBean(dependsOnBean, beanName);</div><div>                      <span style="color: rgb(227, 0, 0);">  getBean(dependsOnBean);</span></div><div>                    }</div><div>                }</div><div><br/></div><div><br/></div><div>               <span style="color: rgb(227, 0, 0);"><b> // Create bean instance.创建bean实例</b></span></div><div>               <b> if (mbd.isSingleton()) {</b></div><div>                    sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() {</div><div>                        @Override</div><div>                        public Object getObject() throws BeansException {</div><div>                            try {</div><div>                                return createBean(beanName, mbd, args);</div><div>                            }</div><div>                            catch (BeansException ex) {</div><div>                                // Explicitly remove instance from singleton cache: It might have been put there</div><div>                                // eagerly by the creation process, to allow for circular reference resolution.</div><div>                                // Also remove any beans that received a temporary reference to the bean.</div><div>                                destroySingleton(beanName);</div><div>                                throw ex;</div><div>                            }</div><div>                        }</div><div>                    });</div><div>                    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div>                }</div><div><br/></div><div>                else if (mbd.isPrototype()) {</div><div>                    // It's a prototype -&gt; create a new instance.</div><div>                    Object prototypeInstance = null;</div><div>                    try {</div><div>                        beforePrototypeCreation(beanName);</div><div>                        prototypeInstance = createBean(beanName, mbd, args);</div><div>                    }</div><div>                    finally {</div><div>                        afterPrototypeCreation(beanName);</div><div>                    }</div><div>                    bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</div><div>                }</div><div><br/></div><div>                else {</div><div>                    String scopeName = mbd.getScope();</div><div>                    final Scope scope = this.scopes.get(scopeName);</div><div>                    if (scope == null) {</div><div>                        throw new IllegalStateException(&quot;No Scope registered for scope '&quot; + scopeName + &quot;'&quot;);</div><div>                    }</div><div>                    try {</div><div>                        Object scopedInstance = scope.get(beanName, new ObjectFactory&lt;Object&gt;() {</div><div>                            @Override</div><div>                            public Object getObject() throws BeansException {</div><div>                                beforePrototypeCreation(beanName);</div><div>                                try {</div><div>                                    return createBean(beanName, mbd, args);</div><div>                                }</div><div>                                finally {</div><div>                                    afterPrototypeCreation(beanName);</div><div>                                }</div><div>                            }</div><div>                        });</div><div>                        bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</div><div>                    }</div><div>                    catch (IllegalStateException ex) {</div><div>                        throw new BeanCreationException(beanName,</div><div>                                &quot;Scope '&quot; + scopeName + &quot;' is not active for the current thread; &quot; +</div><div>                                &quot;consider defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;,</div><div>                                ex);</div><div>                    }</div><div>                }</div><div>            }</div><div>            catch (BeansException ex) {</div><div>                cleanupAfterBeanCreationFailure(beanName);</div><div>                throw ex;</div><div>            }</div><div>        }</div><div><br/></div><div>        // Check if required type matches the type of the actual bean instance.</div><div>        if (requiredType != null &amp;&amp; bean != null &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) {</div><div>            try {</div><div>                return getTypeConverter().convertIfNecessary(bean, requiredType);</div><div>            }</div><div>            catch (TypeMismatchException ex) {</div><div>                if (logger.isDebugEnabled()) {</div><div>                    logger.debug(&quot;Failed to convert bean '&quot; + name + &quot;' to required type [&quot; +</div><div>                            ClassUtils.getQualifiedName(requiredType) + &quot;]&quot;, ex);</div><div>                }</div><div>                throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</div><div>            }</div><div>        }</div><div>        return (T) bean;</div><div>    }</div></div><div><br/></div></div></div></div><div>         
<div align="left" style="min-height: 18pt;"><div><font face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">DefaultSingletonBeanRegistry：</span></font></div><div><span style="font-size: 16pt;"><span style="font-family: Consolas;"><span style="background-color: rgb(232, 242, 254);"> </span></span></span><div align="left" style="min-height: 18pt;"><div><font color="#3F5FBF" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">/** Cache of singleton objects: bean name</span></font> <font color="#7F7F9F" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">--&gt;</span></font> <font color="#3F5FBF" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">bean instance */</span></font><span style="font-size: 16pt;"><span style="font-family: Consolas;"><span style="background-color: rgb(232, 242, 254);">   </span></span></span></div></div></div><div align="left" style="min-height: 18pt;"><div><font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe"><b>private</b></span></font> <font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe"><b>final</b></span></font> <font face="Consolas" size="4"><span style="font-size:16pt; background:#d4d4d4">Map</span><span style="font-size:16pt; background:#e8f2fe">&lt;String, Object&gt;</span></font> <font color="#0000C0" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">singletonObjects</span></font> <font face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">=</span></font> <font color="#7F0055" face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe"><b>new</b></span></font> <font face="Consolas" size="4"><span style="font-size:16pt; background:#e8f2fe">ConcurrentHashMap&lt;String, Object&gt;(64);</span></font></div></div></div></div><div> </div><div align="left" style="min-height: 18pt;"><div>getSingleton方法；</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) {</div><div>        Assert.notNull(beanName, &quot;'beanName' must not be null&quot;);</div><div>        synchronized (this.singletonObjects) {</div><div>               //先从一个地方将这个beanget出来</div><div>            <b>Object singletonObject = this.singletonObjects.get(beanName);</b></div><div>            if (singletonObject == null) {</div><div>                if (this.singletonsCurrentlyInDestruction) {</div><div>                    throw new BeanCreationNotAllowedException(beanName,</div><div>                            &quot;Singleton bean creation not allowed while the singletons of this factory are in destruction &quot; +</div><div>                            &quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;);</div><div>                }</div><div>                if (logger.isDebugEnabled()) {</div><div>                    logger.debug(&quot;Creating shared instance of singleton bean '&quot; + beanName + &quot;'&quot;);</div><div>                }</div><div>                beforeSingletonCreation(beanName);</div><div>                boolean recordSuppressedExceptions = (this.suppressedExceptions == null);</div><div>                if (recordSuppressedExceptions) {</div><div>                    this.suppressedExceptions = new LinkedHashSet&lt;Exception&gt;();</div><div>                }</div><div>                try {</div><div>                    <span style="color: rgb(227, 0, 0);"><b>//创建bean</b></span></div><div><span style="color: rgb(227, 0, 0);"><b>                    singletonObject = singletonFactory.getObject();</b></span></div><div>                }</div><div>                catch (BeanCreationException ex) {</div><div>                    if (recordSuppressedExceptions) {</div><div>                        for (Exception suppressedException : this.suppressedExceptions) {</div><div>                            ex.addRelatedCause(suppressedException);</div><div>                        }</div><div>                    }</div><div>                    throw ex;</div><div>                }</div><div>                finally {</div><div>                    if (recordSuppressedExceptions) {</div><div>                        this.suppressedExceptions = null;</div><div>                    }</div><div>                    afterSingletonCreation(beanName);</div><div>                }</div><div>               //添加创建的bean</div><div>                <b>addSingleton(beanName, singletonObject);</b></div><div>            }</div><div>            return (singletonObject != NULL_OBJECT ? singletonObject : null);</div><div>        }</div><div>    }</div></div><div>创建好的对象最终会保存在一个map中；</div><div>ioc容器之一：保存单实例bean的地方；</div><div>ioc就是一个容器，单实例bean保存在一个map中；</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>DefaultSingletonBeanRegistry-singletonObjects</div></div><div>-----</div><div><hr/></div><div>BeanFactory和ApplicationContext的区别；</div><div><br/></div><div>ApplicationContext是BeanFactory的子接口；</div><div>BeanFactory：bean工厂接口；负责创建bean实例；容器里面保存的所有单例bean其实是一个map；</div><div>          Spring最底层的接口；</div><div>ApplicationContext：是容器接口；更多的负责容器功能的实现；（可以基于beanFactory创建好的对象之上完成强大的容器）</div><div>               容器可以从map获取这个bean，并且aop。di。在ApplicationContext接口的下的这些类里面；</div><div><br/></div><div>BeanFactory最底层的接口，ApplicationContext留给程序员使用的ioc容器接口；ApplicationContext是BeanFactory的子接口；</div><div>ApplicationContext</div><div><br/></div><div>Spring里面最大的模式就是工厂模式；</div><div>          &lt;bean class=&quot;&quot;&gt;&lt;/bean&gt;</div><div>          BeanFactory：bean工厂；工厂模式；帮用户创建bean</div><div>          </div><div><br/></div><div><hr/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div>                 </div><div><br/></div></span>
</div></body></html> 