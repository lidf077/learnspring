<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3231"/>
<h1>5、声明式事务</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/6/16 15:55</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/6/16 16:52</i></td></tr>
<tr><td><b>作者：</b></td><td><i>雷丰阳</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div>环境搭建：</div><div>1、导入sql文件、导入jar</div><div>2、写几个类和方法模拟结账操作；</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>package com.atguigu.dao;</div><div><br/></div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.jdbc.core.JdbcTemplate;</div><div>import org.springframework.stereotype.Repository;</div><div><br/></div><div>@Repository</div><div>public class BookDao {</div><div><br/></div><div>    @Autowired</div><div>    JdbcTemplate jdbcTemplate;</div><div><br/></div><div>    /**</div><div>     * 1、减余额</div><div>     *</div><div>     * 减去某个用户的余额</div><div>     */</div><div>    public void updateBalance(String userName,int price){</div><div>        String sql = &quot;UPDATE## account SET balance=balance-? WHERE username=?&quot;;</div><div>        jdbcTemplate.update(sql, price,userName);</div><div>    }</div><div><br/></div><div>    /**</div><div>     * 2、按照图书的ISBN获取某本图书的价格</div><div>     * @return</div><div>     */</div><div>    public int getPrice(String isbn){</div><div>        String sql = &quot;SELECT price FROM book WHERE isbn=?&quot;;</div><div>        return jdbcTemplate.queryForObject(sql, Integer.class, isbn);</div><div>    }</div><div><br/></div><div>    /**</div><div>     * 3、减库存；减去某本书的库存；为了简单期间每次减一</div><div>     */</div><div>    public void updateStock(String isbn){</div><div>        String sql = &quot;UPDATE book_stock SET stock=stock-1 WHERE isbn=?&quot;;</div><div>        jdbcTemplate.update(sql, isbn);</div><div>    }</div><div><br/></div><div>}</div></div><div><hr/></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>package com.atguigu.service;</div><div><br/></div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.stereotype.Service;</div><div><br/></div><div>import com.atguigu.dao.BookDao;</div><div><br/></div><div>@Service</div><div>public class BookService {</div><div><br/></div><div>    @Autowired</div><div>    BookDao bookDao;</div><div><br/></div><div>    /**</div><div>     * 结账；传入哪个用户买了哪本书</div><div>     * @param username</div><div>     * @param isbn</div><div>     */</div><div>    public void checkout(String username,String isbn){</div><div>        //1、减库存</div><div>        bookDao.updateStock(isbn);</div><div><br/></div><div>        int price = bookDao.getPrice(isbn);</div><div>        //2、减余额</div><div>        bookDao.updateBalance(username, price);</div><div>    }</div><div><br/></div><div>}</div></div><div><br/></div><div><hr/></div><div>声明式事务：</div><div>     以前通过复杂的编程来编写一个事务，替换为只需要告诉Spring哪个方法是事务方法即可；</div><div>     Spring自动进行事务控制；</div><div>编程式事务：</div><div>     TransactionFilter{</div><div>               try{</div><div>                    //获取连接</div><div>                    //设置非自动 提交</div><div>                    chain.doFilter();</div><div>                    //提交</div><div>               }catch(Exception e){</div><div>                    //回滚 </div><div>               }finllay{</div><div>                    //关闭连接释放资源</div><div>               }      </div><div>     }</div><div><hr/></div><div>AOP：环绕通知可以去做；</div><div>                     //获取连接</div><div>                    //设置非自动 提交</div><div>                    目标代码执行</div><div>                    //正常提交</div><div>                    //异常回滚</div><div>                    //最终关闭</div><div><br/></div><div>最终效果：</div><div>          BookService{</div><div><br/></div><div>               @this is a tx-method（Transactional）</div><div>               public void checkout(){</div><div>                         //xxxxx</div><div>               }</div><div>          }</div><div align="justify" style="min-height: 14pt;"><div><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt"><b>事务管理代码的</b></span></font><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt"><b>固定模式</b></span></font><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt"><b>作为一种</b></span></font><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt"><b>横切关注点</b></span></font><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt"><b>，可以通过</b></span></font><font color="#0000FF" face="Calibri" size="2"><span style="font-size:10pt"><b>AOP</b></span></font><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt"><b>方法模块化，进而借助</b></span></font><font color="#FF0000" face="Calibri" size="2"><span style="font-size:10pt"><b>Spring AOP</b></span></font><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt"><b>框架</b></span></font><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt"><b>实现声明式事务管理</b></span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">。</span></font></div><div><font color="#010101" face="宋体">自己要写这个切面还是很麻烦；</font></div><div><font color="#010101" face="宋体">这个切面已经有了；（事务切面===事务管理器）；</font></div><div><img src="5、声明式事务_files/Image.png" type="image/png"/></div><div>这个事务管理器就可以在目标方法运行前后进行事务控制（事务切面）；</div><div>我们目前都使用DataSourceTransactionManager；即可；</div><div><br/></div><div>------</div><div>快速的为某个方法添加事务：</div><div>1）、配置出这个事务管理器让他工作；</div><div>2）、开启基于注解的事务</div><div>3）、给事务方法加@Transactional注解</div><div align="left" style="min-height: 18pt;"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    &lt;!--  配置数据源--&gt;</div><div>    &lt;bean id=&quot;pooledDataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;&gt;</div><div>        &lt;property name=&quot;user&quot; value=&quot;${jdbc.user}&quot;&gt;&lt;/property&gt;</div><div>        &lt;property name=&quot;password&quot; value=&quot;${jdbc.password}&quot;&gt;&lt;/property&gt;</div><div>        &lt;property name=&quot;jdbcUrl&quot; value=&quot;${jdbc.jdbcUrl}&quot;&gt;&lt;/property&gt;</div><div>        &lt;property name=&quot;driverClass&quot; value=&quot;${jdbc.driverClass}&quot;&gt;&lt;/property&gt;</div><div>    &lt;/bean&gt;</div><div><br/></div><div><br/></div><div>    &lt;!-- 配置JdbcTemplate --&gt;</div><div>    &lt;bean class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;</div><div>        &lt;property name=&quot;dataSource&quot; ref=&quot;pooledDataSource&quot;&gt;&lt;/property&gt;</div><div>    &lt;/bean&gt;</div><div><br/></div><div>    &lt;!-- 事务控制 --&gt;</div><div>    &lt;!--1:配置事务管理器（切面）让其进行事务控制；一定导入面向切面编程的几个包</div><div>            spring-aspects-4.0.0.RELEASE.jar</div><div>            com.springsource.net.sf.cglib-2.2.0.jar</div><div>            com.springsource.org.aopalliance-1.0.0.jar</div><div>            com.springsource.org.aspectj.weaver-1.6.8.RELEASE.jar</div><div>    --&gt;</div><div>    &lt;bean id=&quot;tm&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</div><div>        &lt;!-- 控制住数据源 --&gt;</div><div>        &lt;property name=&quot;dataSource&quot; ref=&quot;pooledDataSource&quot;&gt;&lt;/property&gt;</div><div>    &lt;/bean&gt;</div><div>    &lt;!--2:开启基于注解的事务控制模式；依赖tx名称空间  --&gt;</div><div>    &lt;tx:annotation-driven transaction-manager=&quot;tm&quot;/&gt;</div><div>    &lt;!--3:给事务方法加注解@Transactional  --&gt;</div></div><div><br/></div></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 